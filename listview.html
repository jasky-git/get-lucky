<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>

    <title>Timeline</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins:200,300,400,700,900|Display+Playfair:200,300,400,700"> 
    <link rel="stylesheet" href="Travellers/travelers/fonts/icomoon/style.css">

    <link rel="stylesheet" href="Travellers/travelers/css/bootstrap.min.css">
    <link rel="stylesheet" href="Travellers/travelers/css/magnific-popup.css">
    <link rel="stylesheet" href="Travellers/travelers/css/jquery-ui.css">
    <link rel="stylesheet" href="Travellers/travelers/css/owl.carousel.min.css">
    <link rel="stylesheet" href="Travellers/travelers/css/owl.theme.default.min.css">

    <link rel="stylesheet" href="Travellers/travelers/css/bootstrap-datepicker.css">

    <link rel="stylesheet" href="Travellers/travelers/fonts/flaticon/font/flaticon.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mediaelement@4.2.7/build/mediaelementplayer.min.css">


    <link rel="stylesheet" href="Travellers/travelers/css/aos.css">

    <link rel="stylesheet" href="Travellers/travelers/css/style.css">
    
    <a href="javascript:" id="return-to-top"><i class="icon-chevron-up"></i></a>
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="style/scroller.css">
    <script type="text/javascript" src="javascript/scroller.js"></script>
</head>
<body>

    <!--Navigation bar-->
    <div id="nav-placeholder">
    </div>        
    <script>
        $(function(){
            $("#nav-placeholder").load("nav.php");
        });
    </script>
    <!--end of Navigation bar-->
    <div class="site-wrap">
        <div class="site-blocks-cover inner-page-cover" style="background-image: url(image/planning-a-trip-tips-and-challenges-2.jpg);" data-aos="fade" data-stellar-background-ratio="0.5">
            <div class="container">
                <div class="row align-items-center justify-content-center text-center">
                    <div class="col-md-8" data-aos="fade-up" data-aos-delay="400">
                        <h1 class="text-black font-weight-light">Create Itinerary</h1>
                        <div><a href="home.html">Home</a> <span class="mx-2 text-white">&bullet;</span> <span class="text-black">Planner</span></div>
                    </div>
                </div>
            </div>
        </div>  
    
        <div class="site-section bg-light">
            <div class="container">
                <div class="row">
                    <div class="col-md-7 mb-5">
                        <form method="get" class="p-5 bg-white">
    
                            <div class="row form-group">
                                <div class="col-md-6 mb-3 mb-md-0">
                                    <label class="text-black" for="dte">Date</label>
                                    <input type="date" name="dte" id="dte" onchange=setMinTime(this) class= "form-control px-2" required>
                                </div>
                            </div>
    
                            <div class="row form-group">
                                <div class="col-md-6 mb-3 mb-md-0">
                                    <label class="text-black" for="startTime">Start Time</label>
                                    <input type="time" name="startTime" id="startTime" min="09:00" max="19:00" class="form-control" required>
                                </div>
                                <div class="col-md-6 mb-3 mb-md-0">
                                    <label class="text-black" for="endTime">End Time</label>
                                    <input type="time" name="endTime" id="endTime" min="10:00" max="20:00" class="form-control"required>
                                </div>
                            </div>
    
                            <div class="row form-group">
                                <div class="col-md-12">
                                    <label class="text-black" for="packs">Number of People</label>
                                    <input type="number" id="packs" class="form-control" name="packs" min=1 max=100 value=1 placeholder="2" required>
                                </div>
                            </div>
    
                            <div class="row form-group">
                                <div class="col-md-12">
                                    <label class="text-black" for="category">Type of Date</label>
                                    <select name="category" id="category" class="form-control">
                                        <option value="4bf58dd8d48988d17f941735, 4bf58dd8d48988d165941735, 4bf58dd8d48988d181941735">Romantic</option>
                                        <option value="4bf58dd8d48988d181941735, 4bf58dd8d48988d137941735, 4bf58dd8d48988d1e5931735">Formal</option>
                                        <option value="4bf58dd8d48988d1e4931735,4bf58dd8d48988d182941735,4bf58dd8d48988d1fd941735" selected>Casual</option>
                                    </select>
                                </div>
                            </div>
    
                            <div class="row form-group">
                                <div class="col-md-6 mb-3 mb-md-0">
                                    <label class="text-black" for="titleIter">Title of Iternary</label><br>
                                    <input type="text" name="titleIter" required class="form-control" placeholder="Title">
                                </div>
                                <div class="col-md-6 mb-3 mb-md-0">
                                    <label class="text-black" for="startVenue">Starting Venue</label>
                                    <input type="text" name="startVenue" required class="form-control" placeholder="Bugis">
                                </div>
                            </div>
    
                            <br>
    
                            <div class="row form-group">
                                <div class="col-md-12">
                                    <input type="submit" value="Submit" class="btn btn-block btn-primary py-2 px-4 text-white">
                                    <!-- <input type="reset" value="Reset" class="btn btn-primary py-2 px-4 text-white"> -->
                                </div>
                            </div>

                            <br>

                        </form>
                    </div>
                    
                    <div class="col-md-5">
                        <div class="p-4 mb-3 bg-white">
                            <h3 class="h5 text-black mb-3">Your Itinerary: </h3>
                            <div class="result" id="result"></div>
                            <div class="row form-group">
                                <div class="btn-result pl-4"></div>
                            </div>
                            
                        </div>
                    </div>
                </div>
            </div>

            <!-- over here -->
            <!-- <div class="container">
                <div class="row custom-one">
                    <div class="col-md-12">
                        <div class="row form-group">
                            <div class="col-12">
                                <div class="result px-3 pt-4" id="result"></div>
                            </div>
                        </div>
                        <div class="row form-group">
                            <div class="btn-result pl-4"></div>
                        </div>
                    </div>
                </div>
            </div> -->
            
        </div>

        
    </div>

    
    
    <script>
        const form = document.querySelector('form');
        const foodId = "4bf58dd8d48988d16d941735"; //food -> cafe (foursquare)
        let result = document.querySelector('.result');
        let btnResult = document.querySelector('.btn-result');
        let category = '';
        let startVenue = '';
        let startTime = ''
        let endTime = ''
        let dte = '';
        let title = '';
        let categories = '';
        let arr = [];
        let timeArr = '';
        // categories,startVenue,startTime,endTime,dte,title

        /*--------- STARTUP FUNCTION ---------*/
        window.onload = function() {
            var current_date = new Date()
            function formatDate(date) {
                var d = new Date(date),
                    month = '' + (d.getMonth() + 1),
                    day = '' + d.getDate(),
                    year = d.getFullYear();

                if (month.length < 2) 
                    month = '0' + month;
                if (day.length < 2) 
                    day = '0' + day;

                return [year, month, day].join('-');
            }
            
            // setting the current time as the minimum to start and end on windows load up
            current_time = current_date.toTimeString();
            console.log(current_time.substring(0,5));
            document.getElementById("startTime").min = current_time.substring(0,5);
            document.getElementById("startTime").value = current_time.substring(0,5);

            document.getElementById("endTime").min = current_time.substring(0,5);
            document.getElementById("endTime").value = current_time.substring(0,5);

            document.getElementById("dte").min = formatDate(current_date);
            document.getElementById("dte").value = formatDate(current_date);
            console.log(formatDate(current_date));
        }

        // if date selected is a future date, min start and end time goes back to original
        function setMinTime(obj) {
            console.log(obj.value)
            var current_date = new Date()
            if (new Date(obj.value) > current_date) {
                console.log("yes");
                document.getElementById("startTime").min = "09:00";
                document.getElementById("endTime").min = "10:00";
            }
        }

        /*--------- ONSUBMIT FORM BUTTON ---------*/
        form.addEventListener('submit', event => {
            event.preventDefault();

            category = form.category.value;
            startVenue = form.startVenue.value;
            dte = form.dte.value;
            title = form.titleIter.value;
            categories = category.split(',');

            // get start and end time, and get activities based on times
            const start = form.startTime.value;
            const end = form.endTime.value;
            console.log(start);
            console.log(end);

            let roundTime = (time, minutesToRound) => {

                let [hours, minutes] = time.split(':');
                hours = parseInt(hours);
                minutes = parseInt(minutes);

                // Convert hours and minutes to time in minutes
                time = (hours * 60) + minutes; 

                let rounded = Math.round(time / minutesToRound) * minutesToRound;
                let rHr = ''+Math.floor(rounded / 60)
                let rMin = ''+ rounded % 60

                return rHr.padStart(2, '0')+':'+rMin.padStart(2, '0')
            }

            startTime = roundTime(start,60);
            endTime = roundTime(end,60);
            console.log(startTime);
            console.log(endTime);
          /*
            var itinerary_result = document.getElementById("result");
            while (itinerary_result.hasChildNodes()) {  
                itinerary_result.removeChild(itinerary_result.firstChild);
                }
                
          */
            getAPIData(categories,startVenue,startTime,endTime,dte,title);
            

            // validate start time < end time
            if(startTime>endTime) {
                alert("Start time cannot be more than end time!");
            } else if(startTime == endTime) {
                alert("Start time must be different from end time!")
            }

            // ----------- end of time ---------------
        });


        /*--------- FUNCTION CALLS ---------*/
        function assignTime(data,startTime,endTime,dte,title,categories,startVenue){
            console.log(data);
            timeArr = [];

            // document.querySelector('.custom-one').classList.add('bg-white');
            // result.insertAdjacentHTML('beforeend', `<h2 class='mb-3'>Results</h2>`);
            let counterTmp = 1;

            // based on time, get activities
            if(startTime < "12:00") {
                // get activity for morning
                console.log("get morning activity");
                console.log('---- ' + data[0].venue);
                timeArr.push(data[0]);
                if(endTime > "12:00"){
                    result.insertAdjacentHTML('beforeend', `${startTime} - 12:00  <strong>${data[0].venue}</strong><br>`);
                }
                else{
                    result.insertAdjacentHTML('beforeend', `${startTime} - ${endTime}  <strong>${data[0].venue}</strong><br>`);
                }
                counterTmp ++;
            }

            if(startTime <= "12:00" && endTime >= "13:00") {
                console.log("have lunch");
                console.log('---- ' + data[1].venue);
                timeArr.push(data[1]);
                result.insertAdjacentHTML('beforeend', `12:00 - 13:00  <strong>Have Lunch at: ${data[1].venue}</strong></style><br>`);
                counterTmp ++;
            }

            if(startTime <= "13:00" && endTime >= "15:30" ) {
                console.log("get afternoon activity 1");
                console.log('---- ' + data[2].venue);
                timeArr.push(data[2]);
                if(endTime >= "15:30"){
                    result.insertAdjacentHTML('beforeend', `13:00 - 15:30  <strong>${data[2].venue}</strong><br>`);
                }
                else{
                    result.insertAdjacentHTML('beforeend', `13:00 - ${endTime}  <strong>${data[2].venue}</strong><br>`);
                }
                counterTmp ++;
            }

            if(startTime <= "15:30" &&  endTime >= "18:00") {
                console.log("get afternoon activity 2");
                console.log('---- ' + data[3].venue);
                timeArr.push(data[3]);
                if(endTime >= "18:00"){
                    result.insertAdjacentHTML('beforeend', `15:30 - 18:00  <strong>${data[3].venue}</strong><br>`);
                }
                else{
                    result.insertAdjacentHTML('beforeend', `15:30 - ${endTime}  <strong>${data[3].venue}</strong><br>`);
                }
                counterTmp ++;
            }

            if(startTime <= "18:00" && endTime >= "19:00") {
                // have to edit to accept end timings such as 6.30... or need to round up the timing
                console.log("get dinner");
                console.log('---- ' + data[4].venue);
                timeArr.push(data[4]);
                result.insertAdjacentHTML('beforeend', `18:00 - 19:00  <strong>Grab Dinner at: ${data[4].venue}</strong><br>`);
                counterTmp ++;
            }
            
            if(btnResult.innerHTML === ''){
                createButtons();
            }
        }

        function clickRetry(){
            arr = [];
            result.innerHTML = '';
            // document.querySelector('.custom-one').classList.remove('bg-white');
            getAPIData(categories,startVenue,startTime,endTime,dte,title);
        }

        let itemProcessed = 0;

        function clickSubmit(timeArr){
            timeArr.forEach((value,index,array) => {
                fetch('processListview.php', {
                    method: 'POST', 
                    headers: {
                        'Content-Type': "application/x-www-form-urlencoded"
                    },
                    body: "venueId="+value.id+"&venue="+value.venue+"&address="+value.address+"&lat="+value.lat+"&lng="+value.lng+"&title="+title+"&date="+dte,
                })
                .then(response => response.text())
                .then(data => {
                    // console.log(data);
                    itemProcessed++;
                    if (itemProcessed === array.length){
                        //call function
                        processTelegram();
                    }
                })
                .catch(error => console.log(error))
            });
        }

        function processTelegram(){
            fetch('tele_confirmation_process.php',{
                method: 'POST',
                headers: {
                    'Content-Type': "application/x-www-form-urlencoded"
                },
                body: "title="+title
            })
            .then(response => response.text())
            .then(data => {
                console.log('telegram message send');
                return window.location.href = './home.html';
            })
            .catch(error => console.log(error));
        }

        function createButtons(){
            //creation of submit and retry buttons
            btnResult.insertAdjacentHTML('beforeend', `
                                        <br><br>
                                        <button type='button' class='retry-btn btn btn-danger py-2 px-4 text-white' onclick='clickRetry()'>Find New Activties</button>
                                        <button type='button' class='submit-btn btn btn-success py-2 px-4 text-white' onclick='clickSubmit(timeArr)'>Proceed to Plan</button>
                                        `
            );
        }

        function getAPIData(categories,startVenue,startTime,endTime,dte,title){
            let counter = 0;
            let tempArr = null;
            fetch(`https://api.foursquare.com/v2/venues/search?limit=1&intent=checkin&radius=2500&categoryId=${categories[0]}&near=${startVenue}&client_id=UEYIIOJSEV0ZA4UQHMHRB2NOLAAHFFI5OMG5IBJVCMV21SGG&client_secret=22I2YDXRFJVAIOZZSY2XVKO2BGAGSOCK5UGY422AVFMPHSE3&v=20191030`)
            .then(response => response.json())
            .then(data => {
                // console.log(data);
                tempArr = getData(data, counter);
                // console.log(tempArr);
                counter ++;
                return fetch(`https://api.foursquare.com/v2/venues/search?limit=15&intent=checkin&radius=2500&categoryId=${foodId}&ll=${tempArr[0].lat},${tempArr[0].lng}&client_id=UEYIIOJSEV0ZA4UQHMHRB2NOLAAHFFI5OMG5IBJVCMV21SGG&client_secret=22I2YDXRFJVAIOZZSY2XVKO2BGAGSOCK5UGY422AVFMPHSE3&v=20191030`);
            })
            .then(response => response.json())
            .then(data => {
                tempArr = getData(data, counter);
                // console.log(tempArr);
                counter ++;
                return fetch(`https://api.foursquare.com/v2/venues/search?limit=15&intent=browse&radius=2500&categoryId=${categories[1]}&ll=${tempArr[1].lat},${tempArr[1].lng}&client_id=UEYIIOJSEV0ZA4UQHMHRB2NOLAAHFFI5OMG5IBJVCMV21SGG&client_secret=22I2YDXRFJVAIOZZSY2XVKO2BGAGSOCK5UGY422AVFMPHSE3&v=20191030`);
            })
            .then(response => response.json())
            .then(data => {
                tempArr = getData(data, counter);
                return fetch(`https://api.foursquare.com/v2/venues/search?limit=15&intent=checkin&radius=2500&categoryId=${categories[2]}&ll=${tempArr[2].lat},${tempArr[2].lng}&client_id=UEYIIOJSEV0ZA4UQHMHRB2NOLAAHFFI5OMG5IBJVCMV21SGG&client_secret=22I2YDXRFJVAIOZZSY2XVKO2BGAGSOCK5UGY422AVFMPHSE3&v=20191030`);
            })
            .then(response => response.json())
            .then(data => {
                tempArr = getData(data, counter);
                // console.log(tempArr);
                return fetch(`https://api.foursquare.com/v2/venues/search?limit=15&intent=checkin&radius=2500&categoryId=${foodId}&ll=${tempArr[3].lat},${tempArr[3].lng}&client_id=UEYIIOJSEV0ZA4UQHMHRB2NOLAAHFFI5OMG5IBJVCMV21SGG&client_secret=22I2YDXRFJVAIOZZSY2XVKO2BGAGSOCK5UGY422AVFMPHSE3&v=20191030`);
            })
            .then(response => response.json())
            .then(data => {
                return tempArr = getData(data, counter);
                // console.log(tempArr);
            })
            .then(data => {
                console.log(dte);
                console.log(title);
                assignTime(data,startTime,endTime,dte,title,categories,startVenue);
            })
        }
    
        function getData(data, counter){
            let res = data.response.venues;
            let cc;
            let state = false;
            let innerCounter = counter;
            
            while (!state){
                if(counter > 0) {
                    innerCounter = Math.floor(Math.random() * Math.floor(res.length-1));
                    // console.log(innerCounter);
                }
                console.log(res[innerCounter]); 
                cc = res[innerCounter].location.cc;

                if(cc === 'SG'){
                    state = true;
                }
            }

            // console.log(res[innerCounter]);
            // let address;
            let venueId = res[innerCounter].id;
            let venue = res[innerCounter].name;
            let address = 'NIL';
            if('address' in res[innerCounter].location === true){
                address = res[innerCounter].location.address;
            } 
            let lat = res[innerCounter].location.lat;
            let lng = res[innerCounter].location.lng;

            let obj = {id:venueId, venue:venue, address:address, lat:lat, lng:lng};
            
            arr.push(obj);
            return arr;
            // console.log(arr);
            
        }

    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="Travellers/travelers/js/jquery-3.3.1.min.js"></script>
    <script src="Travellers/travelers/js/jquery-migrate-3.0.1.min.js"></script>
    <script src="Travellers/travelers/js/jquery-ui.js"></script>
    <script src="Travellers/travelers/js/popper.min.js"></script>
    <script src="Travellers/travelers/js/bootstrap.min.js"></script>
    <script src="Travellers/travelers/js/owl.carousel.min.js"></script>
    <script src="Travellers/travelers/js/jquery.stellar.min.js"></script>
    <script src="Travellers/travelers/js/jquery.countdown.min.js"></script>
    <script src="Travellers/travelers/js/jquery.magnific-popup.min.js"></script>
    <script src="Travellers/travelers/js/bootstrap-datepicker.min.js"></script>
    <script src="Travellers/travelers/js/aos.js"></script>
    <script src="Travellers/travelers/js/main.js"></script>
</body>
</html>