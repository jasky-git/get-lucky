<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <form method="get">
        Number of People: <input type="number" name="packs" min=1 max=100 value=1 required> <br>
        Date:<input type="date" name="dte" id="dte" onchange=setMinTime(this) required> <br>
        Start Time: <input type="time" name="startTime" id="startTime" min="09:00" max="18:00" required><br> 
        End Time: <input type="time" name="endTime" id="endTime" min="10:00" max="19:00" required><br> 
        Category: 
        <select name="category">
            <option value="">romance</option>
            <option value="">formal</option>
            <option value="4bf58dd8d48988d1e4931735,4bf58dd8d48988d182941735" selected>casual</option>
        </select> <br>
        Budget: 
        <input type="radio" name="budget" value='cheap'>$ 
        <input type="radio" name="budget" value='moderate'>$$
        <input type="radio" name="budget" value='high'>$$$
        <br>
        Venue to start the date: <input type="text" name="startVenue" required>
        <br>
        <!-- Start time of date: <input type="number" name="startTime">
        <br>
        End time of date: <input type="number" name="endTime">
        <br> -->
        <input type="submit" value="Submit"> <input type="reset" value="Reset">
    </form>

    <div class="result"></div>
    
    <script>
        const form = document.querySelector('form');
        const foodId = "4bf58dd8d48988d16d941735"; //food -> cafe (foursquare)
        const arr = [];

        /*--------- STARTUP FUNCTION ---------*/
        window.onload = function() {
            var current_date = new Date()
            function formatDate(date) {
                var d = new Date(date),
                    month = '' + (d.getMonth() + 1),
                    day = '' + d.getDate(),
                    year = d.getFullYear();

                if (month.length < 2) 
                    month = '0' + month;
                if (day.length < 2) 
                    day = '0' + day;

                return [year, month, day].join('-');
            }
            
            // setting the current time as the minimum to start and end on windows load up
            current_time = current_date.toTimeString();
            console.log(current_time.substring(0,5));
            document.getElementById("startTime").min = current_time.substring(0,5);
            document.getElementById("startTime").value = current_time.substring(0,5);

            document.getElementById("endTime").min = current_time.substring(0,5);
            document.getElementById("endTime").value = current_time.substring(0,5);

            document.getElementById("dte").min = formatDate(current_date);
            document.getElementById("dte").value = formatDate(current_date);
            console.log(formatDate(current_date));
        }

        // if date selected is a future date, min start and end time goes back to original
        function setMinTime(obj) {
            console.log(obj.value)
            var current_date = new Date()
            if (new Date(obj.value) > current_date) {
                console.log("yes");
                document.getElementById("startTime").min = "09:00";
                document.getElementById("endTime").min = "10:00";
            }
        }

        /*--------- ONSUBMIT FORM BUTTON ---------*/
        form.addEventListener('submit', event => {
            event.preventDefault();
            
            const budget = form.budget.value;
            const category = form.category.value;
            const startVenue = form.startVenue.value;
            const categories = category.split(',');

            // get start and end time, and get activities based on times
            const start = form.startTime.value;
            const end = form.endTime.value;
            console.log(start);
            console.log(end);

            let roundTime = (time, minutesToRound) => {

                let [hours, minutes] = time.split(':');
                hours = parseInt(hours);
                minutes = parseInt(minutes);

                // Convert hours and minutes to time in minutes
                time = (hours * 60) + minutes; 

                let rounded = Math.round(time / minutesToRound) * minutesToRound;
                let rHr = ''+Math.floor(rounded / 60)
                let rMin = ''+ rounded % 60

                return rHr.padStart(2, '0')+':'+rMin.padStart(2, '0')
            }

            const startTime = roundTime(start,60);
            const endTime = roundTime(end,60);
            console.log(startTime);
            console.log(endTime);

            getAPIData(categories,startVenue,startTime,endTime);
            // console.log(arr);
            // console.log(resArr);

            // validate start time < end time
            if(startTime>endTime) {
                alert("Start time cannot be more than end time!");
            } else if(startTime == endTime) {
                alert("Start time must be different from end time!")
            }

            // ----------- end of time ---------------
        });


        /*--------- FUNCTION CALLS ---------*/
        function assignTime(data,startTime,endTime){
            console.log(data);
            // based on time, get activities
            if(startTime < "12:00") {
                // get actitivty for morning
                console.log("get morning activity");
                
            }

            if(startTime <= "12:00" && endTime >= "13:00") {
                console.log("have lunch");
            }

            if(startTime <= "13:00" && endTime >= "15:30" ) {
                console.log("get afternoon activity 1");
                console.log('---- ' + data[0].venue);
            }

            if(startTime <= "15:30" && endTime >= "18:00") {
                console.log("get afternoon activity 2");
                console.log('---- ' + data[1].venue);
            }

            if(startTime <= "18:00" && endTime >= "19:00") {
                // have to edit to accept end timings such as 6.30... or need to round up the timing
                console.log("get dinner");
                console.log('---- ' + data[2].venue);
            }
        }

        function getAPIData(categories,startVenue,startTime,endTime){
            let counter = 0;
            let tempArr = null;
            fetch(`https://api.foursquare.com/v2/venues/search?limit=1&intent=checkin&radius=2500&categoryId=${categories[0]}&near=${startVenue}&client_id=UEYIIOJSEV0ZA4UQHMHRB2NOLAAHFFI5OMG5IBJVCMV21SGG&client_secret=22I2YDXRFJVAIOZZSY2XVKO2BGAGSOCK5UGY422AVFMPHSE3&v=20191030`)
            .then(response => response.json())
            .then(data => {
                // console.log(data);
                tempArr = getData(data, counter);
                // console.log(tempArr);
                counter ++;
                return fetch(`https://api.foursquare.com/v2/venues/search?limit=10&intent=checkin&radius=2500&categoryId=${foodId}&ll=${tempArr[0].lat},${tempArr[0].lng}&client_id=UEYIIOJSEV0ZA4UQHMHRB2NOLAAHFFI5OMG5IBJVCMV21SGG&client_secret=22I2YDXRFJVAIOZZSY2XVKO2BGAGSOCK5UGY422AVFMPHSE3&v=20191030`);
            })
            .then(response => response.json())
            .then(data => {
                tempArr = getData(data, counter);
                // console.log(tempArr);
                counter ++;
                return fetch(`https://api.foursquare.com/v2/venues/search?limit=10&intent=browse&radius=2500&categoryId=${categories[1]}&ll=${tempArr[1].lat},${tempArr[1].lng}&client_id=UEYIIOJSEV0ZA4UQHMHRB2NOLAAHFFI5OMG5IBJVCMV21SGG&client_secret=22I2YDXRFJVAIOZZSY2XVKO2BGAGSOCK5UGY422AVFMPHSE3&v=20191030`);
            })
            .then(response => response.json())
            .then(data => {
                // getData(data);
                return tempArr = getData(data, counter);
                // console.log(tempArr);
                // return window.location.href = './confirmation.php';
            })
            .then(data => {
                console.log(data,startTime,endTime);
                //call calculatetime function
                assignTime(data,startTime,endTime);
            })
        }
    
        function getData(data, counter){
            let res = data.response.venues;
            let cc;
            let rand;
            let state = false;
            let innerCounter = counter;
            
            //check if location is in SG and if not just random the number again
            if(counter > 0) {
                while (!state){
                    innerCounter = Math.floor(Math.random() * Math.floor(res.length-1));
                    // console.log(innerCounter);
                    cc = res[innerCounter].location.cc;
                    if(cc === "SG"){
                        state = true;
                    }
                }
            } 

            // console.log(res[innerCounter]);
            let venueId = res[innerCounter].id;
            let venue = res[innerCounter].name;
            let address = res[innerCounter].location.address;
            let lat = res[innerCounter].location.lat;
            let lng = res[innerCounter].location.lng;

            let obj = {id:venueId, venue:venue, address:address, lat:lat, lng:lng};

            //do the post request here?
            // $.ajax({
            //     type: 'POST',
            //     url: 'processListview.php',
            //     data: {"id": venueId, "venue": venue, "address": address, "lat": lat, "lng": lng},
            //     success: function(msg){
            //         if(msg) {
            //             console.log(msg);
            //         }
            //     }
            // });
            
            arr.push(obj);
            return arr;
            // console.log(arr);

            // fetch(`https://api.foursquare.com/v2/venues/search?limit=10&intent=browse&radius=20000&categoryId=${value}&near=${startVenue}&client_id=PZI4I3GHW3KXKVK2X2YX1OVMVQRIXZULZMR2EF0D3RCBNRKO&client_secret=W0XUFTFI5ZPWMB2C4SZMMLYWZTUKCDWYRE0TC02ALQZ3U1HD&v=20191030`)
            
        }

        // get the venue details -> price
        // not all food venues have prices -> might be a problem
        // function getDetails(venueId){
        //     fetch(`https://api.foursquare.com/v2/venues/${venueId}?client_id=PZI4I3GHW3KXKVK2X2YX1OVMVQRIXZULZMR2EF0D3RCBNRKO&client_secret=W0XUFTFI5ZPWMB2C4SZMMLYWZTUKCDWYRE0TC02ALQZ3U1HD&v=20191030`)
        //     .then(response => response.json())
        //     .then(data => {
        //         // console.log(data);
        //     });
        // }


    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</body>
</html>